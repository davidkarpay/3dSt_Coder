<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3dSt Platform</title>
    <style>
        :root {
            /* Medieval Gothic Law Library Color Palette */
            --primary-bg: #0a2a2a;
            --secondary-bg: #1a3a3a;
            --tertiary-bg: #2a4a4a;
            --accent-gold: #d4af37;
            --accent-dark-gold: #b8860b;
            --accent-burgundy: #722f37;
            --text-primary: #e6d7c3;
            --text-secondary: #c9b896;
            --text-muted: #a68a5a;
            --border-ornate: #d4af37;
            --border-subtle: #4a5a5a;
            --shadow-warm: rgba(212, 175, 55, 0.3);
            --shadow-deep: rgba(10, 42, 42, 0.8);
            --error-parchment: #d2691e;
            --success-illuminated: #228b22;
        }

        body {
            font-family: 'Times New Roman', 'Georgia', 'Garamond', serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--primary-bg) 0%, #0f2f2f 50%, var(--secondary-bg) 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            background-attachment: fixed;
        }

        /* Main layout grid */
        .main-layout {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
            max-width: 100vw;
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
            overflow: hidden;
        }

        /* Responsive breakpoints */
        @media (min-width: 768px) {
            .content-wrapper {
                grid-template-columns: 280px 1fr;
                gap: 10px;
                padding: 10px;
            }
        }

        @media (min-width: 1200px) {
            .content-wrapper {
                grid-template-columns: 280px 1fr 250px;
                max-width: 1400px;
                margin: 0 auto;
            }
        }

        /* Compact header styling */
        .compact-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            background: linear-gradient(145deg, var(--secondary-bg), var(--tertiary-bg));
            border-bottom: 2px solid var(--accent-gold);
            min-height: 60px;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-brand h1 {
            color: var(--accent-gold);
            text-shadow: 2px 2px 4px var(--shadow-deep);
            font-size: 1.4em;
            margin: 0;
            letter-spacing: 1px;
        }

        .header-subtitle {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin: 0;
        }

        /* Legacy header for login screen */
        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--accent-gold);
            padding-bottom: 15px;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
        }

        .header h1 {
            color: var(--accent-gold);
            text-shadow: 2px 2px 4px var(--shadow-deep);
            font-size: 2.2em;
            margin: 0;
            letter-spacing: 1px;
        }

        .login-container {
            max-width: 420px;
            margin: 100px auto;
            padding: 40px;
            background: linear-gradient(145deg, var(--secondary-bg) 0%, var(--tertiary-bg) 100%);
            border: 2px solid var(--accent-dark-gold);
            border-radius: 20px 20px 10px 10px;
            box-shadow:
                0 8px 32px var(--shadow-deep),
                inset 0 1px 0 var(--shadow-warm);
            position: relative;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 20px;
            background: var(--accent-gold);
            border-radius: 10px 10px 0 0;
            opacity: 0.3;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--accent-gold);
            text-shadow: 1px 1px 2px var(--shadow-deep);
            font-size: 1.1em;
        }

        .form-group input {
            padding: 15px;
            border: 2px solid var(--border-subtle);
            border-radius: 8px;
            background: linear-gradient(145deg, var(--primary-bg), #1a2a2a);
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: inset 2px 2px 4px var(--shadow-deep);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow:
                inset 2px 2px 4px var(--shadow-deep),
                0 0 12px var(--shadow-warm);
            background: linear-gradient(145deg, #0f2525, var(--primary-bg));
        }

        .login-button {
            padding: 15px 25px;
            background: linear-gradient(145deg, var(--accent-gold), var(--accent-dark-gold));
            color: var(--primary-bg);
            border: 2px solid var(--accent-dark-gold);
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow:
                0 4px 8px var(--shadow-deep),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .login-button:hover {
            background: linear-gradient(145deg, #f4d03f, var(--accent-gold));
            transform: translateY(-2px);
            box-shadow:
                0 6px 12px var(--shadow-deep),
                0 0 20px var(--shadow-warm),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .login-button:disabled {
            background: linear-gradient(145deg, var(--border-subtle), #3a3a3a);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: inset 2px 2px 4px var(--shadow-deep);
        }

        .error-message {
            color: var(--error-parchment);
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(210, 105, 30, 0.1);
            border: 1px solid var(--error-parchment);
            border-radius: 8px;
            font-style: italic;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px 20px;
            background: linear-gradient(145deg, var(--secondary-bg), var(--tertiary-bg));
            border: 2px solid var(--accent-dark-gold);
            border-radius: 12px;
            box-shadow: 0 4px 8px var(--shadow-deep);
        }

        .logout-button {
            padding: 10px 18px;
            background: linear-gradient(145deg, var(--accent-burgundy), #5a252a);
            color: var(--text-primary);
            border: 2px solid var(--accent-burgundy);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .logout-button:hover {
            background: linear-gradient(145deg, #8b3a3a, var(--accent-burgundy));
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-deep);
        }

        .hidden {
            display: none;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            border: 2px solid var(--accent-gold);
            border-radius: 15px;
            background: linear-gradient(145deg, var(--secondary-bg) 0%, var(--tertiary-bg) 100%);
            position: relative;
            box-shadow: 0 8px 16px var(--shadow-deep);
            overflow: hidden;
        }

        /* Sidebar panels */
        .sidebar {
            background: linear-gradient(145deg, var(--tertiary-bg), var(--secondary-bg));
            border: 2px solid var(--border-subtle);
            border-radius: 15px;
            padding: 15px;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: var(--accent-gold);
            font-size: 1.1em;
            margin: 0 0 15px 0;
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 8px;
        }

        /* Hide sidebars on mobile */
        @media (max-width: 767px) {
            .sidebar {
                display: none;
            }
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 30px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
            border-radius: 15px 15px 0 0;
            opacity: 0.4;
        }

        .chat-container::after {
            content: '🚀';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: var(--accent-gold);
            text-shadow: 2px 2px 4px var(--shadow-deep);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background:
                radial-gradient(circle at 20% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(114, 47, 55, 0.05) 0%, transparent 50%),
                var(--secondary-bg);
            margin: 8px;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
        }

        /* Compact toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: linear-gradient(145deg, var(--tertiary-bg), var(--secondary-bg));
            border-bottom: 1px solid var(--border-subtle);
            flex-wrap: wrap;
            min-height: 50px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-label {
            font-size: 0.9em;
            color: var(--accent-gold);
            font-weight: 600;
            white-space: nowrap;
        }

        .compact-select {
            padding: 6px 10px;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 0.9em;
            min-width: 120px;
        }

        .compact-button {
            padding: 4px 8px;
            font-size: 0.8em;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            background: linear-gradient(145deg, var(--border-subtle), #3a4a4a);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .compact-button.active {
            background: linear-gradient(145deg, var(--accent-gold), var(--accent-dark-gold));
            color: var(--primary-bg);
            border-color: var(--accent-dark-gold);
        }

        .status-indicator {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-left: auto;
        }

        .message {
            margin-bottom: 20px;
            padding: 18px 22px;
            border-radius: 15px;
            max-width: 85%;
            position: relative;
            box-shadow: 0 4px 8px var(--shadow-deep);
        }

        .user-message {
            background: linear-gradient(145deg, var(--accent-gold), var(--accent-dark-gold));
            color: var(--primary-bg);
            margin-left: auto;
            text-align: right;
            border: 2px solid var(--accent-dark-gold);
            font-weight: 500;
        }

        .user-message::before {
            content: '👤';
            position: absolute;
            top: -8px;
            right: 15px;
            font-size: 16px;
            background: var(--accent-gold);
            padding: 4px 8px;
            border-radius: 50%;
            border: 2px solid var(--accent-dark-gold);
        }

        .assistant-message {
            background: linear-gradient(145deg, var(--tertiary-bg), var(--secondary-bg));
            color: var(--text-primary);
            margin-right: auto;
            border: 2px solid var(--border-subtle);
        }

        .assistant-message::before {
            content: '⚖';
            position: absolute;
            top: -8px;
            left: 15px;
            font-size: 16px;
            color: var(--accent-gold);
            background: var(--secondary-bg);
            padding: 4px 8px;
            border-radius: 50%;
            border: 2px solid var(--accent-gold);
        }

        .input-container {
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-top: 2px solid var(--accent-dark-gold);
            background: linear-gradient(145deg, var(--tertiary-bg), var(--secondary-bg));
            border-radius: 0 0 15px 15px;
            gap: 10px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .file-upload-btn {
            padding: 8px 12px;
            background: linear-gradient(145deg, var(--border-subtle), #3a4a4a);
            color: var(--text-secondary);
            border: 2px solid var(--border-subtle);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .file-upload-btn:hover {
            background: linear-gradient(145deg, #5a6a6a, var(--border-subtle));
            color: var(--text-primary);
        }

        .file-upload-btn input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .attachment-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            min-height: 0;
            max-height: 60px;
            overflow-y: auto;
        }

        .attachment-chip {
            background: linear-gradient(145deg, var(--accent-gold), var(--accent-dark-gold));
            color: var(--primary-bg);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 4px;
            max-width: 120px;
        }

        .attachment-chip .filename {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .attachment-chip .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border-subtle);
            border-radius: 12px;
            background: linear-gradient(145deg, var(--primary-bg), #1a2a2a);
            color: var(--text-primary);
            resize: none;
            min-height: 40px;
            max-height: 120px;
            font-family: inherit;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: inset 1px 1px 3px var(--shadow-deep);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow:
                inset 2px 2px 4px var(--shadow-deep),
                0 0 15px var(--shadow-warm);
        }

        .message-input::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .send-button {
            padding: 12px 20px;
            background: linear-gradient(145deg, var(--accent-gold), var(--accent-dark-gold));
            color: var(--primary-bg);
            border: 2px solid var(--accent-dark-gold);
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px var(--shadow-deep);
        }

        .send-button::before {
            content: '🚀';
            margin-right: 6px;
        }

        .send-button:hover {
            background: linear-gradient(145deg, #f4d03f, var(--accent-gold));
            transform: translateY(-2px);
            box-shadow:
                0 6px 12px var(--shadow-deep),
                0 0 20px var(--shadow-warm);
        }

        .send-button:disabled {
            background: linear-gradient(145deg, var(--border-subtle), #3a3a3a);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: inset 2px 2px 4px var(--shadow-deep);
        }

        .typing-indicator {
            color: var(--text-muted);
            font-style: italic;
            padding: 15px 25px;
            text-align: center;
            background: rgba(212, 175, 55, 0.1);
            margin: 10px 25px;
            border-radius: 10px;
            border: 1px solid var(--accent-dark-gold);
        }

        .typing-indicator::before {
            content: '✒ ';
            color: var(--accent-gold);
        }

        .network-status {
            background: linear-gradient(145deg, var(--secondary-bg), var(--tertiary-bg));
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            border: 2px solid var(--border-subtle);
            box-shadow: 0 4px 8px var(--shadow-deep);
        }

        .status-ok {
            color: var(--success-illuminated);
            text-shadow: 1px 1px 2px var(--shadow-deep);
        }

        .status-error {
            color: var(--error-parchment);
            text-shadow: 1px 1px 2px var(--shadow-deep);
        }

        .model-selection {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px;
            padding: 20px;
            background: linear-gradient(145deg, var(--tertiary-bg), var(--secondary-bg));
            border: 2px solid var(--accent-dark-gold);
            border-radius: 15px;
            position: relative;
            box-shadow: 0 6px 12px var(--shadow-deep);
        }

        .model-selection::before {
            content: '📚';
            position: absolute;
            top: -12px;
            left: 20px;
            font-size: 20px;
            background: var(--accent-gold);
            padding: 6px 10px;
            border-radius: 50%;
            border: 2px solid var(--accent-dark-gold);
        }

        .model-selection label {
            font-weight: 600;
            color: var(--accent-gold);
            text-shadow: 1px 1px 2px var(--shadow-deep);
            font-size: 1em;
            margin-right: 5px;
        }

        .model-select {
            padding: 12px 16px;
            border: 2px solid var(--border-subtle);
            border-radius: 10px;
            background: linear-gradient(145deg, var(--primary-bg), #1a2a2a);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            box-shadow: inset 2px 2px 4px var(--shadow-deep);
        }

        .model-select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow:
                inset 2px 2px 4px var(--shadow-deep),
                0 0 12px var(--shadow-warm);
        }

        .task-type-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-button {
            padding: 8px 15px;
            background: linear-gradient(145deg, var(--border-subtle), #3a4a4a);
            color: var(--text-secondary);
            border: 2px solid var(--border-subtle);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .task-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .task-button:hover {
            background: linear-gradient(145deg, #5a6a6a, var(--border-subtle));
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-deep);
        }

        .task-button:hover::before {
            left: 100%;
        }

        .task-button.active {
            background: linear-gradient(145deg, var(--accent-gold), var(--accent-dark-gold));
            color: var(--primary-bg);
            border-color: var(--accent-dark-gold);
            box-shadow:
                0 4px 8px var(--shadow-deep),
                0 0 15px var(--shadow-warm);
            transform: translateY(-2px);
        }

        .model-status {
            font-size: 14px;
            color: var(--text-muted);
            margin-left: auto;
            padding: 8px 15px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--accent-dark-gold);
            border-radius: 20px;
            font-style: italic;
            text-shadow: 1px 1px 2px var(--shadow-deep);
        }

        .model-status::before {
            content: '⚡ ';
            color: var(--accent-gold);
        }

        /* File upload and attachment styles */
        .file-drop-zone {
            border: 2px dashed var(--border-subtle);
            border-radius: 12px;
            padding: 20px;
            margin: 15px;
            text-align: center;
            color: var(--text-muted);
            background: rgba(42, 74, 74, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .file-drop-zone.drag-over {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.1);
            color: var(--accent-gold);
            transform: scale(1.02);
        }

        .file-drop-zone input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-drop-zone::before {
            content: '📁';
            font-size: 24px;
            display: block;
            margin-bottom: 10px;
        }

        .file-attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px;
            min-height: 40px;
            max-height: 120px;
            overflow-y: auto;
        }

        .file-attachment {
            background: linear-gradient(145deg, var(--tertiary-bg), var(--secondary-bg));
            border: 2px solid var(--border-subtle);
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            position: relative;
            max-width: 200px;
        }

        .file-attachment::before {
            content: '📄';
            font-size: 16px;
        }

        .file-attachment.processing::before {
            content: '⏳';
        }

        .file-attachment.processed::before {
            content: '✅';
        }

        .file-attachment.error::before {
            content: '❌';
        }

        .file-attachment .filename {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-attachment .remove-btn {
            background: var(--accent-burgundy);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .file-attachment .remove-btn:hover {
            background: #8b3a3a;
            transform: scale(1.1);
        }

        .task-detection-result {
            margin: 15px;
            padding: 12px 18px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--accent-dark-gold);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            display: none;
        }

        .task-detection-result.visible {
            display: block;
        }

        .task-detection-result::before {
            content: '🧠 ';
            color: var(--accent-gold);
        }

        .confidence-bar {
            width: 100%;
            height: 4px;
            background: var(--border-subtle);
            border-radius: 2px;
            margin: 5px 0;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-burgundy), var(--accent-gold));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Atmospheric Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-bg);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(145deg, var(--accent-dark-gold), var(--accent-gold));
            border-radius: 6px;
            border: 2px solid var(--primary-bg);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(145deg, var(--accent-gold), #f4d03f);
        }

        /* Subtle animations */
        @keyframes candleFlicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .chat-container::after {
            animation: candleFlicker 3s ease-in-out infinite;
        }

        /* Selection styling */
        ::selection {
            background: var(--shadow-warm);
            color: var(--text-primary);
        }

        /* Focus ring for accessibility */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--accent-gold);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="header">
            <h1>🔐 3dSt Login</h1>
            <p>Secure AI Platform</p>
        </div>

        <div class="network-status" id="network-status">
            <span id="network-message">Checking network access...</span>
        </div>

        <form class="login-form" id="login-form">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required autocomplete="username">
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
            </div>

            <button type="submit" class="login-button" id="login-button">
                Login
            </button>

            <div class="error-message" id="error-message"></div>
        </form>
    </div>

    <!-- Main Chat Interface -->
    <div id="chat-screen" class="hidden main-layout">
        <!-- Compact Header -->
        <div class="compact-header">
            <div class="header-brand">
                <h1>🚀 3dSt Platform</h1>
                <p class="header-subtitle">AI-Powered Development & Automation</p>
            </div>
            <div class="user-info" id="user-info">
                <span id="user-display"></span>
                <button class="logout-button" id="logout-button">Logout</button>
            </div>
        </div>

        <!-- Content Wrapper -->
        <div class="content-wrapper">
            <!-- Left Sidebar (Model Controls) -->
            <div class="sidebar" id="controls-sidebar">
                <h3>🛠️ Controls</h3>
                <div class="model-selection">
                    <label for="model-select">Model:</label>
                    <select id="model-select" class="compact-select">
                        <option value="">Auto-detect</option>
                    </select>
                </div>
                <div class="task-selection">
                    <label>Task Type:</label>
                    <div class="task-type-buttons">
                        <button class="compact-button active" data-task="">Auto</button>
                        <button class="compact-button" data-task="code_generation">Code</button>
                        <button class="compact-button" data-task="code_review">Review</button>
                        <button class="compact-button" data-task="documentation">Docs</button>
                        <button class="compact-button" data-task="debugging">Debug</button>
                        <button class="compact-button" data-task="general">General</button>
                    </div>
                </div>
                <div class="model-status" id="model-status">Loading models...</div>
            </div>

            <!-- Main Chat Area -->
            <div class="chat-container">
                <!-- Compact Toolbar -->
                <div class="toolbar">
                    <div class="status-indicator" id="model-status-inline">Ready</div>
                </div>

                <div class="messages" id="messages"></div>
                <div class="typing-indicator hidden" id="typing-indicator">Assistant is thinking...</div>

                <!-- Task detection result -->
                <div class="task-detection-result" id="task-detection-result">
                    <div class="detection-text"></div>
                    <div class="confidence-bar">
                        <div class="confidence-fill"></div>
                    </div>
                </div>

                <!-- Integrated Input Area -->
                <div class="input-container">
                    <!-- File attachments preview -->
                    <div class="attachment-preview" id="file-attachments"></div>

                    <!-- Input row with controls -->
                    <div class="input-row">
                        <div class="input-controls">
                            <label class="file-upload-btn">
                                📁
                                <input type="file" id="file-input" multiple accept=".txt,.py,.js,.ts,.jsx,.tsx,.html,.css,.scss,.md,.json,.yaml,.yml,.xml,.sql,.sh,.bat,.pdf,.docx,.doc,.c,.cpp,.h,.hpp,.java,.go,.rs,.php,.rb,.swift,.kt,.scala,.r">
                            </label>
                        </div>
                        <textarea
                            id="message-input"
                            class="message-input"
                            placeholder="Ask me anything - upload files, get code help, analyze documents..."
                            rows="2"
                        ></textarea>
                        <button id="send-button" class="send-button">Send</button>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar (Future: History, Tools, etc.) -->
            <div class="sidebar" id="info-sidebar">
                <h3>📊 Status</h3>
                <div class="status-section">
                    <p>Files uploaded: <span id="file-count">0</span></p>
                    <p>Model: <span id="current-model">Auto</span></p>
                    <p>Task: <span id="current-task">Auto</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication state
        let authToken = localStorage.getItem('auth_token');
        let currentUser = null;

        // DOM elements
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const userDisplay = document.getElementById('user-display');
        const logoutButton = document.getElementById('logout-button');
        const networkStatus = document.getElementById('network-status');
        const networkMessage = document.getElementById('network-message');
        const modelSelect = document.getElementById('model-select');
        const modelStatus = document.getElementById('model-status');
        const taskButtons = document.querySelectorAll('.compact-button');
        const fileDropZone = document.getElementById('file-drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileAttachments = document.getElementById('file-attachments');
        const taskDetectionResult = document.getElementById('task-detection-result');

        // Model selection state
        let selectedModel = '';
        let selectedTask = '';
        let uploadedFiles = [];  // Array of {file_id, filename, processed}

        // Check authentication status on load
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/status', {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });

                const status = await response.json();

                // Update network status
                if (status.network_access) {
                    networkMessage.textContent = `✅ Network access allowed (${status.network_info.ip})`;
                    networkStatus.className = 'network-status status-ok';
                } else {
                    networkMessage.textContent = '❌ Network access denied';
                    networkStatus.className = 'network-status status-error';
                    return;
                }

                if (status.authenticated && authToken) {
                    currentUser = status.user;
                    showChatScreen();
                } else {
                    showLoginScreen();
                }

                // Check if admin user exists
                if (!status.admin_exists) {
                    errorMessage.textContent = 'No admin user found. Please run the admin creation script first.';
                    errorMessage.style.color = '#ff9800';
                }

            } catch (error) {
                console.error('Auth status check failed:', error);
                networkMessage.textContent = '❌ Connection failed';
                networkStatus.className = 'network-status status-error';
                showLoginScreen();
            }
        }

        // Show login screen
        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
        }

        // Show chat screen
        function showChatScreen() {
            loginScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            userDisplay.textContent = `Logged in as: ${currentUser.username} (${currentUser.role})`;
            loadModelStatus();
        }

        // Load available models and current status
        async function loadModelStatus() {
            try {
                const response = await fetch('/api/v1/models/status', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateModelSelect(data);
                    updateModelStatus(data);
                } else {
                    modelStatus.textContent = 'Error loading models';
                }
            } catch (error) {
                console.error('Error loading model status:', error);
                modelStatus.textContent = 'Error loading models';
            }
        }

        // Update model selector dropdown
        function updateModelSelect(data) {
            // Clear existing options except the first one
            modelSelect.innerHTML = '<option value="">Auto-detect</option>';

            data.available_models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;

                // Create detailed option text
                let optionText = `${model.name}`;

                // Add engine type badge
                optionText += ` [${model.engine_type.toUpperCase()}]`;

                // Add availability indicator
                if (model.available) {
                    optionText += ' ✅';
                } else {
                    optionText += ' ❌';
                }

                // Add task types if available
                if (model.task_types && model.task_types.length > 0) {
                    const taskTypes = model.task_types.join(', ');
                    optionText += ` - ${taskTypes}`;
                }

                option.textContent = optionText;
                option.disabled = !model.available;
                option.title = model.description || `${model.engine_type} model: ${model.name}`;

                // Add style classes based on availability
                if (!model.available) {
                    option.style.color = '#888';
                    option.style.fontStyle = 'italic';
                }

                modelSelect.appendChild(option);
            });
        }

        // Update model status display
        function updateModelStatus(data) {
            const availableCount = data.available_models.filter(m => m.available).length;
            const totalCount = data.available_models.length;

            let statusText = `${availableCount}/${totalCount} models`;

            // Add engine type breakdown
            const engineTypes = {};
            data.available_models.forEach(model => {
                if (model.available) {
                    engineTypes[model.engine_type] = (engineTypes[model.engine_type] || 0) + 1;
                }
            });

            if (Object.keys(engineTypes).length > 0) {
                const engineBreakdown = Object.entries(engineTypes)
                    .map(([type, count]) => `${count} ${type.toUpperCase()}`)
                    .join(', ');
                statusText += ` (${engineBreakdown})`;
            }

            modelStatus.textContent = statusText;
            modelStatus.title = `Available engines: ${Object.keys(engineTypes).join(', ')}`;
        }

        // Handle task button clicks
        taskButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                taskButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                button.classList.add('active');
                // Update selected task
                selectedTask = button.dataset.task;
                updateCurrentTask(selectedTask || 'Auto');
            });
        });

        // Handle model select change
        modelSelect.addEventListener('change', () => {
            selectedModel = modelSelect.value;
            updateCurrentModel(selectedModel || 'Auto');
        });

        // Handle login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('username', document.getElementById('username').value);
            formData.append('password', document.getElementById('password').value);

            const loginButton = document.getElementById('login-button');
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';
            errorMessage.textContent = '';

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    localStorage.setItem('auth_token', authToken);
                    await checkAuthStatus();
                } else {
                    const error = await response.json();
                    errorMessage.textContent = error.detail || 'Login failed';
                }
            } catch (error) {
                errorMessage.textContent = 'Network error. Please try again.';
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Login';
            }
        });

        // Handle logout
        logoutButton.addEventListener('click', async () => {
            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }

            authToken = null;
            currentUser = null;
            localStorage.removeItem('auth_token');
            showLoginScreen();
        });

        // Handle sending messages
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !authToken) return;

            // Add user message to chat
            addMessage(message, 'user');
            messageInput.value = '';

            // Show typing indicator
            typingIndicator.classList.remove('hidden');
            sendButton.disabled = true;

            try {
                const response = await fetch('/api/v1/chat/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        message: message,
                        project_id: 'default',
                        preferred_model: selectedModel || null,
                        task_type: selectedTask || null,
                        attached_files: uploadedFiles.length > 0 ? uploadedFiles.map(f => f.file_id) : null
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    addMessage(data.response, 'assistant');
                } else {
                    const error = await response.json();
                    addMessage(`Error: ${error.detail}`, 'assistant');
                }
            } catch (error) {
                addMessage('Network error. Please try again.', 'assistant');
            } finally {
                typingIndicator.classList.add('hidden');
                sendButton.disabled = false;
            }
        }

        // Add message to chat
        function addMessage(content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // File upload functionality
        function initializeFileUpload() {
            // Drag and drop handlers for the entire chat container
            const chatContainer = document.querySelector('.chat-container');

            chatContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                chatContainer.style.outline = '2px dashed var(--accent-gold)';
            });

            chatContainer.addEventListener('dragleave', (e) => {
                e.preventDefault();
                chatContainer.style.outline = 'none';
            });

            chatContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                chatContainer.style.outline = 'none';
                const files = Array.from(e.dataTransfer.files);
                handleFileSelection(files);
            });

            // File input handler
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFileSelection(files);
                e.target.value = ''; // Reset input
            });

            // Update file count display
            updateFileCount();
        }

        async function handleFileSelection(files) {
            for (const file of files) {
                await uploadFile(file);
            }
        }

        async function uploadFile(file) {
            // Create attachment element
            const attachmentDiv = createFileAttachment(file.name, 'processing');
            fileAttachments.appendChild(attachmentDiv);

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/v1/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();

                    // Update attachment state
                    attachmentDiv.className = 'file-attachment processed';
                    attachmentDiv.dataset.fileId = result.file_id;

                    // Add to uploaded files list
                    uploadedFiles.push({
                        file_id: result.file_id,
                        filename: result.filename,
                        processed: result.processed
                    });

                    updateFileCount();
                    console.log('File uploaded successfully:', result);

                    // Trigger task detection if this is the first file
                    if (uploadedFiles.length === 1) {
                        detectTaskType();
                    }
                } else {
                    const error = await response.json();
                    attachmentDiv.className = 'file-attachment error';
                    console.error('File upload failed:', error);
                }
            } catch (error) {
                attachmentDiv.className = 'file-attachment error';
                console.error('File upload error:', error);
            }
        }

        function createFileAttachment(filename, status = 'processing') {
            const chipDiv = document.createElement('div');
            chipDiv.className = `attachment-chip ${status}`;

            const filenameSpan = document.createElement('span');
            filenameSpan.className = 'filename';
            filenameSpan.textContent = filename;
            filenameSpan.title = filename;

            const removeSpan = document.createElement('span');
            removeSpan.className = 'remove';
            removeSpan.textContent = '×';
            removeSpan.onclick = () => removeFileAttachment(chipDiv);

            chipDiv.appendChild(filenameSpan);
            chipDiv.appendChild(removeSpan);

            return chipDiv;
        }

        async function removeFileAttachment(attachmentDiv) {
            const fileId = attachmentDiv.dataset.fileId;

            if (fileId) {
                try {
                    await fetch(`/api/v1/files/${fileId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    // Remove from uploaded files list
                    uploadedFiles = uploadedFiles.filter(f => f.file_id !== fileId);
                    updateFileCount();
                } catch (error) {
                    console.error('Error deleting file:', error);
                }
            }

            attachmentDiv.remove();

            // Re-detect task if files remain
            if (uploadedFiles.length > 0) {
                detectTaskType();
            } else {
                hideTaskDetection();
            }
        }

        async function detectTaskType() {
            const message = messageInput.value.trim();

            if (!message && uploadedFiles.length === 0) {
                hideTaskDetection();
                return;
            }

            try {
                const params = new URLSearchParams();
                params.append('message', message || 'Analyze uploaded files');

                if (uploadedFiles.length > 0) {
                    uploadedFiles.forEach(file => {
                        params.append('attached_files', file.filename);
                    });
                }

                const response = await fetch(`/api/v1/tasks/detect?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showTaskDetection(result);
                } else {
                    console.error('Task detection failed:', response.statusText);
                }
            } catch (error) {
                console.error('Task detection error:', error);
            }
        }

        function showTaskDetection(result) {
            const detectionText = taskDetectionResult.querySelector('.detection-text');
            const confidenceFill = taskDetectionResult.querySelector('.confidence-fill');

            detectionText.innerHTML = `
                Detected task: <strong>${result.detected_task}</strong><br>
                <small>${result.reasoning}</small>
            `;

            confidenceFill.style.width = `${result.confidence * 100}%`;
            taskDetectionResult.classList.add('visible');

            // Auto-select the detected task button
            taskButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.task === result.detected_task) {
                    btn.classList.add('active');
                    selectedTask = result.detected_task;
                }
            });
        }

        function hideTaskDetection() {
            taskDetectionResult.classList.remove('visible');
        }

        // Update file count and status displays
        function updateFileCount() {
            const fileCountElement = document.getElementById('file-count');
            if (fileCountElement) {
                fileCountElement.textContent = uploadedFiles.length;
            }
        }

        // Update current model display
        function updateCurrentModel(modelName) {
            const currentModelElement = document.getElementById('current-model');
            if (currentModelElement) {
                currentModelElement.textContent = modelName || 'Auto';
            }
        }

        // Update current task display
        function updateCurrentTask(taskType) {
            const currentTaskElement = document.getElementById('current-task');
            if (currentTaskElement) {
                currentTaskElement.textContent = taskType || 'Auto';
            }
        }

        // Enhanced message input handler for task detection
        let taskDetectionTimeout;
        messageInput.addEventListener('input', () => {
            clearTimeout(taskDetectionTimeout);
            taskDetectionTimeout = setTimeout(() => {
                if (messageInput.value.trim().length > 10) {
                    detectTaskType();
                }
            }, 1000); // Debounce for 1 second
        });

        // Initialize app
        initializeFileUpload();
        checkAuthStatus();
    </script>
</body>
</html>